---
layout:     post
title:      "swarm 笔记"
subtitle:   ""
date:       2021-06-08 17:33:00
author:     "kgzhang"
catalog: false
header-style: text
tags:
  - blockChain
  - swarm
---

## 安装部署
+ [官方文档](https://docs.ethswarm.org/docs/installation/install/)

### 环境
- 操作系统：Ubuntu 20.04 LTS
- 安装包存放路径：/home/ubuntu
- 当前用户：root

### 一、安装 Bee Clef
依次执行下面 2 条命令：
```
wget https://github.com/ethersphere/bee-clef/releases/download/v0.4.12/bee-clef_0.4.12_amd64.deb
dpkg -i bee-clef_0.4.12_amd64.deb
```

我们开始检查Bee-Clef是否正常运行
```
systemctl status bee-clef
```

执行上述命令后输出信息中含有 active 时，说明 bee-clef 正常运行。

### 二、安装 Bee
依次执行下面 2 条命令：
```
wget https://github.com/ethersphere/bee/releases/download/v0.6.2/bee_0.6.2_amd64.deb
dpkg -i bee_0.6.2_amd64.deb
```

## 服务配置

### 修改配置文件
- 配置文件位置：/etc/bee/bee.yaml
- 主机公网ip：执行此命令 curl icanhazip.com 获取主机的公网 ip。 
- 对 bee.yaml 配置文件做如下改动。如果该项前面有 # ，则需要去掉 #

需要修改的配置项如下所示：
```
# full-node 设置为 true
full-node: true
# swap-endpoint 设置为 http://eth.holdcloud.com
swap-endpoint: http://eth.holdcloud.com
# nat-addr 设置为公网ip
nat-addr: 主机公网ip:1634
```

### 修改用户权限
把 bee 加入 root 用户组
```
usermod -a -G root bee
chmod 666 /var/lib/bee/statestore/CURRENT.bak
```

### 重启服务

使用如下命令启动服务。（在未充水前启动会报错，因为启动必须往节点账号重置相应的 ETH和BZZ 测试币）
```
systemctl restart bee
```

## 充水

使用如下命令查看钱包地址，把钱包地址发送给运营人员充水。
```
bee-get-addr
```

## 兑换票据

### 1）查看节点连接数
```
http://节点ip:节点端口/peers
```
说明：address 越多说明节点连接数越多、节点越健康，如果无法访问或者返回404 说明节点有问题

使用封装好的命令：
```
curl -s http://localhost:1635/peers | jq '.peers | length'
```

### 2）查看节点是否有票据
```
http://节点ip:节点端口/chequebook/cheque
```
说明：返回json或空或有值为正常 字典中key为lastreceived 的值为非null 为有效票据，null为空票

### 3）兑换票（为post请求）
```
curl -X POST "192.168.66.240:17000/chequebook/cashout/$peer"
```
说明：
+ $peer 为字典key为lastreceived 的值为非空中key为peer的值
+ 返回 200为正常兑换

### 4）查看票据是否已经兑换（为get请求）
```
curl -s "192.168.66.240:17000/chequebook/cashout/$peer
```
说明：
+ $peer 为字典key为lastreceived 的值为非空中key为peer的值
+ 返回 404 为此票未兑换 返回json为已经兑换

## 其他命令

### 查看 bee 日志
```
journalctl --lines=100 --follow --unit bee
```

### 如何判断一个节点是否正常运行
执行如下命令，返回Ethereum Swarm Bee
```
curl http://localhost:1633
```

检查已连接的节点数大于0
```
curl -s http://localhost:1635/peers | jq '.peers | length'
```

## 常见问题

### 推荐配置
https://github.com/ethersphere/bee/issues/1927

## 专业名词
+ chequebook contract
+ cashing out cheques
+ Goerli node
 
### 充水/接水 fund your bee
因为启动Swarm项目需要质押gBZZ测试币，但由于免费领取测试币的接口都被专门薅羊毛的搞光了，被薅出的gBZZ就被成为“水”

启动Bee节点需要消耗一定量的gBZZ币，若节点无gBZZ币，则Bee节点无法正常运行。

#### 如何免费领取gETH和gBZZ
##### 方法1 
目前最好的就是通过 https://faucet.goerli.mudit.blog/ 发twitter领取完，再到https://app.uniswap.org/#/swap?use=V2 去兑换gBZZ,兑换步骤参考https://www.bcskill.com/index.php/archives/1105.html

##### 方法2
或者https://discord.gg/GU22h2utj6 中的#faucet频道去领取
发送 /faucet sprinkle 你的地址

## 参考资料
+ swarm 官方目前唯一下载地址：https://github.com/ethersphere/bee/releases
+ 酷多，https://www.kuduo.com/
+ 管理后台，https://nameme.cn/#/pages/adv/adv
+ 区块链中文社区，https://www.bcskill.com/index.php/category/Ethereum-%E6%96%B0%E6%89%8B%E6%95%99%E7%A8%8B/3/