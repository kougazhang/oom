---
layout: post
title: "又拍云探案: 为 nsq 配置监控服务"
tagline: "NSQ 监控"
categories: junk
image: /thumbnail-mobile.png
author: "张召"
meta: "Springfield"
tags: NSQ 
---


在 Go 语言实现的实时消息队列中, NSQ 的热度可以排第一. NSQ 以分布式架构, 能够处理数亿级别的消息能力俘获了众多 gopher 的心. 我司也不例外, NSQ 用的那叫一个飞起, 能推 NSQ 的服务绝不直连, 等到一出故障的时候, 不参照架构图, 你一下子还真想不到居然这俩八竿子打不着的服务早就靠着 NSQ 眉来眼去多时了 ... 额, 有些跑题了, 言归正传. 今天不是 NSQ 的吐槽大会, 今天小拍想和大家唠一唠关于 NSQ 监控的问题.

首先大家知道监控的重要性吗? 

没有监控的服务就是 "盲人骑瞎马, 夜半临深池". 这样讲可能有些抽象, 小拍给大家分享一个小拍亲历的真实案例吧.

话说那日小拍跟葛大爷一样正吃着火锅唱着歌, 心里甭提有多美了, 突然手机响了, 打开一看, 工单来了, 有客户投诉 CDN 刷新成功后未生效.

及时响应客户需求是我司永远不变的宗旨, 更何况是出了问题呢? 二话不说, 小拍抱起电脑一顿操作猛如虎, 可惜结果不靠谱. 刷新调用链路上的相关服务的日志都查过了, 可惜工单上给出的需要刷新的 URL 却没在日志中查到任务蛛丝马迹. 那问题出在哪呢? 

![nsq-monitor02](nsq-monitor02.png)  

调用链路图又称 "服务连连看", 是你在没有把整条链路刻在脑子里又想了解服务之间关系时的唯一选择. 一时之间没有头绪, 小拍对着调用链路图沉思起来:
1. 用户成功提交了刷新请求, 说明兄弟部门调用了小拍负责的相关接口是成功的, 那说明没刷新成功的锅在小拍这, 是甩不掉的.
2. d 服务是网关层 gateway, 记录的是 ERROR 级的 log, 没有查询 URL 相关的记录说明 d 调用下游服务 nsq 是正常的.
3. nsq 对应的消费者是 g. g 负责执行刷新动作, 它记录的日志是 INFO 级, 每一条刷新的 URL 它都会记录到日志中. 但是在 g 中却查不到日志, 为什么呢? 刚才小拍就卡在了这里.

哪些情况下 g 会查不到对应的日志呢?
- [x] 服务变更. g 服务如果最近更新的代码如果有 Bug 可能导致了异常. 小拍很快排除了这点, 因为小拍看了一下发布记录, 最近几个月这个服务没人动过.
- [x] nsq 坏了. 这个更不靠谱, nsq 是集群部署的, 单点故障可以避免, 全局故障的话恐怕整个公司都要炸了.
- [x] nsq 没把消息发过来. 这个 nsq 不是实时消息队列吗? 消息投递按道理很快啊, 而且工单上写客户的刷新操作是在几个小时之前了.

nsq 会不会因为消息堆积了所以才没及时把消息投递过来呢? 想到这儿时, 小拍脑海里不由自主地想起来了柯南专属的 BGM, 看来 "真相只有一个", 小拍赶紧推了推眼镜框, 跑到 nsq 的控制台看对应的 Topic, 果然消息堆积了, 而且足足有几亿条.

问题定位后, 小拍通过内部专属工具替客户把刷新的 URL 刷新调了. 

问题解决了工单处理了事情就解决了吗? 不, 小拍可是立志要成为海贼王一样的技术大牛, 所以先打算给 NSQ 服务加个监控以后 nsq 堆积的话尽可能早点感知到. (画外音: 不加监控, 小拍也就编不下去了, 各位看官大大干货马上就来了.)

因为我司已经的基础设施, 小拍决定使用 Prometheus 来监控 NSQ 服务. (Prometheus 的相关背景知识就不在这里科普了, 想看的请留言.) 

Prometheus 通过 exporter 去采集第三方服务的数据, 也就是说 NSQ 必须配置一个 exporter 才能接入 Prometheus.

Prometheus 的[官方文档](https://prometheus.io/docs/instrumenting/exporters/)上对比较好的 exporter 有官方推荐, 小拍顺着链接找到了官方推荐的 [NSQ exporter](https://github.com/lovoo/nsq_exporter). NSQ exporter 这个项目年久失修, 最近的一次提交已经在 4 年前.

![nsq-monitor03](nsq-monitor03.png)

于是乎小拍把这个项目 clone 到本地, 做了一些简单的改造, 使它支持 go mod. [PR 在这里](https://github.com/lovoo/nsq_exporter/pull/29)

NSQ exporter 部署完成后, 接下来的问题是哪些指标需要监控? 

参考[官网](https://nsq.io/components/nsqadmin.html) 小拍认为这些指标需要重点关注:
+ Depth: 当前 NSQ 堆积的消息. NSQ 在内存中默认只保存 8000 消息, 超过的消息会持久化到磁盘中. 
+ Requeued: 消息 requeue 的次数.
+ Timed Out: 处理超时的消息.

Prometheus 建议配置 Grafana 更加直观地查看指标的变动情况, 小拍配置大体的效果如下:
![nsq-monitor04](nsq-monitor04.png)
+ 超时消息对应着 Timed Out 指标
+ 堆积消息对应着 Depth 指标
+ 负载是根据公式 `sum(irate(nsq_topic_message_count{}[5m]))` 生成的. 
+ 探测服务是探测 NSQ exporter 服务是否正常. 因为该服务经常会因为 NSQ 压力过来导致 exporter 自身服务不可用.




